<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DevQuest ê´€ë¦¬ì í˜ì´ì§€</title>

  <!--cdn-->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- sidenav -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!--css-->
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/admin/header.css">
  <link rel="stylesheet" href="/css/admin/sidenav.css">
  <link rel="stylesheet" href="/css/admin/adminDashboard.css">
</head>

<body>

<!-- fragments -->
<div th:replace="~{fragments/admin-header :: header}"></div>
<div th:replace="~{fragments/admin-sidenav :: sidenav}"></div>

<main>
  <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem;"><b
      th:text="${nickname} + ' ê´€ë¦¬ìë‹˜, ë°˜ê°‘ìŠµë‹ˆë‹¤!'"></b></h2>
  <!-- Dashboard ìš”ì•½ ì¹´ë“œ-->
  <div class="dashboard-summary-wrapper">
    <div class="dashboard-summary-card card">
      <div class="card-content">
        <span class="card-title">Summary</span>
        <div class="summary-content">
          <div class="summary-row">
            ğŸ‘¤ ì˜¤ëŠ˜ ê°€ì…í•œ ì‚¬ìš©ìëŠ” <b id="today-join">0</b>ëª…, íƒˆí‡´í•œ ì‚¬ìš©ìëŠ” <b id="today-leave">0</b>ëª… ì´ì—ìš”!
          </div>
          <br/>
          <div class="summary-row">
            ğŸ¤“ ì§€ê¸ˆ ì‚¬ìš©ìë“¤ì€ <b id="top-langs"></b>ì— ê´€ì‹¬ì´ ë§ì•„ìš”!<br/>
            <br/>
            ğŸ¢ ì§€ê¸ˆ ì‚¬ìš©ìë“¤ì€ <b id="top-companies"></b> ê¸°ì—…ì— ê´€ì‹¬ì„ ê°–ê³  ìˆì–´ìš”!
          </div>
        </div>
      </div>
    </div>

    <!-- ë ˆë²¨ ìƒìœ„ ìœ ì € Top 3 -->
    <div class="card top-level-card">
      <div class="card-header-with-link">
        <span class="card-title">ğŸ† Level Top3</span>
        <a href="/admin/member-management" class="view-all-link">ì „ì²´ ë³´ê¸°</a>
      </div>

      <ul class="top-user-list" id="top-user-list">
        <!-- JSê°€ ì´ ì•ˆì— <li>ë¥¼ ë™ì ìœ¼ë¡œ ë„£ì–´ì¤Œ -->
      </ul>
    </div>
  </div>

  <!-- ì°¨íŠ¸ ì˜ì—­-->
  <div class="dashboard-charts-row">
    <!-- ì°¨íŠ¸1. íšŒì› ê°€ì…/íƒˆí‡´ ì°¨íŠ¸ -->
    <div class="dashboard-chart-card">
      <div class="card-toolbar-title">ğŸ‘¤ íšŒì› ê°€ì…/íƒˆí‡´ í˜„í™©</div>
      <div class="card">
        <div class="card-toolbar">
          <div class="card-toolbar-actions">
            <div class="chips-wrapper">
              <div data-index="0" class="chip white-text"
                   style="background-color: rgb(156,204,129);">ê°€ì…ì ìˆ˜
              </div>
              <div data-index="1" class="chip white-text"
                   style="background-color: rgb(172,172,172);">íƒˆí‡´ì ìˆ˜
              </div>
            </div>
          </div>
        </div>
        <div class="card-content">
          <canvas id="memberChart"></canvas>
        </div>
      </div>
    </div>
    <!-- ì°¨íŠ¸2. íšŒì› ê´€ì‹¬íƒœê·¸ (ì§ë¬´, ì–¸ì–´) ì°¨íŠ¸ -->
    <div class="dashboard-chart-card">
      <div class="card-toolbar-title">ğŸ¤“ íšŒì› ê´€ì‹¬íƒœê·¸ (ì§ë¬´, ì–¸ì–´)</div>
      <div class="card">
        <div class="card-toolbar">
          <div class="card-toolbar-actions">
            <div class="chips-wrapper" id="lang-chips-wrapper">
              <!-- JSì—ì„œ ë™ì ìœ¼ë¡œ ì¹© ìƒì„± -->
            </div>
          </div>
        </div>
        <div class="card-content">
          <canvas id="langChart"></canvas>
        </div>
      </div>
    </div>
    <!-- ì°¨íŠ¸3. ê¸°ì—…í†µê³„ ì°¨íŠ¸ -->
    <div class="dashboard-chart-card">
      <div class="card-toolbar-title">ğŸ¢ ê¸°ì—…ë³„ ì§€ì›ì ìˆ˜ í†µê³„</div>
      <div class="card">
        <div class="card-toolbar">
          <div class="card-toolbar-actions">
            <div class="chips-wrapper" id="company-chips-wrapper">
              <!-- JSì—ì„œ ë™ì ìœ¼ë¡œ ì¹© ìƒì„± -->
            </div>
          </div>
        </div>
        <div class="card-content">
          <canvas id="stacked-bar-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- sidenav ì´ˆê¸°í™” -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const elems = document.querySelectorAll('.sidenav');
    M.Sidenav.init(elems, {
      onOpenStart: function () {
        document.querySelector('.top-header').style.display = 'none';
      },
      onCloseEnd: function () {
        document.querySelector('.top-header').style.display = '';
      }
    });
  });
</script>

<!-- ë ˆë²¨ ìƒìœ„ ìœ ì € Top 5 js ë Œë”ë§-->
<script>
  fetch('/admin/dashboard/top-members')
  .then(res => {
    if (!res.ok) {
      throw new Error('ì„œë²„ ì‘ë‹µ ì—ëŸ¬');
    }
    return res.json();
  })
  .then(data => {
    const list = document.getElementById('top-user-list');
    list.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°

    data.forEach((member, idx) => {
      const li = document.createElement('li');
      li.className = 'top-member-item';
      li.innerHTML = `
          <img src="${member.profileImageUrl}" class="profile-img" alt="${member.nickname}" />
          <span class="rank">ìš°ìˆ˜ í™œë™ ë©¤ë²„ ${idx + 1}ìœ„</span>
          <span class="membername">${member.nickname} ë‹˜</span>
          <span class="level">Lv.${member.level.levelId}</span>
        `;
      list.appendChild(li);
    });
  })
  .catch(err => console.error('Top user fetch ì‹¤íŒ¨:', err));
</script>

<!-- ì°¨íŠ¸ ë°ì´í„° ë° ì´ˆê¸°í™” -->
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function () {
    // ì°¨íŠ¸ ë°ì´í„°
    const labels = /*[[${labels}]]*/ [];
    const joinData = /*[[${joinData}]]*/ [];
    const leaveData = /*[[${leaveData}]]*/ [];
    const langLabels = /*[[${langLabels}]]*/ [];
    const langScores = /*[[${langScores}]]*/ [];
    const langScoresOrigin = [...langScores]; // ì›ë³¸ ë°ì´í„° ë”°ë¡œ ì €ì¥

    // ì¹©ì˜ ì›ë˜ ìƒ‰ìƒ ì €ì¥
    const chipColors = [
      'rgb(156, 204, 129)',   // ê°€ì…ì ìˆ˜
      'rgb(172, 172, 172)'    // íƒˆí‡´ì ìˆ˜
    ];

    // íšŒì› ê°€ì…/íƒˆí‡´ ì°¨íŠ¸
    const memberCtx = document.getElementById('memberChart');
    if (memberCtx) {
      const memberChart = new Chart(memberCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ê°€ì…ì ìˆ˜',
            data: joinData,
            borderColor: 'rgb(156, 204, 129)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: 'íƒˆí‡´ì ìˆ˜',
            data: leaveData,
            borderColor: 'rgb(172, 172, 172)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              display: false // ì¹©ìœ¼ë¡œ ëŒ€ì²´í•˜ë¯€ë¡œ ê¸°ë³¸ ë²”ë¡€ëŠ” ìˆ¨ê¹€
            },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                precision: 0
              },
              grid: {
                drawBorder: false
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });

      // ì¹© í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ (X ì•„ì´ì½˜ ì—†ì´ ì¹© ì „ì²´ë¥¼ í† ê¸€)
      document.querySelectorAll('.chips-wrapper .chip').forEach((chip, index) => {
        chip.addEventListener('click', function () {
          const datasetIndex = parseInt(this.dataset.index);
          const meta = memberChart.getDatasetMeta(datasetIndex);
          meta.hidden = !meta.hidden;
          memberChart.update();

          // í™œì„±/ë¹„í™œì„±ì— ë”°ë¼ ì¹© ìƒ‰ìƒ ë³€ê²½
          if (meta.hidden) {
            this.style.backgroundColor = '#bdbdbd'; // ë¹„í™œì„±í™”: íšŒìƒ‰
          } else {
            this.style.backgroundColor = chipColors[datasetIndex]; // í™œì„±í™”: ì›ë˜ ìƒ‰ìƒ
          }
        });
      });
    }

    // // ì§ë¬´ë³„ ìƒ‰ìƒ ë°°ì—´ (í•„ìš”ì‹œ ë” ì¶”ê°€)
    const langChipColors = [
      'rgb(255, 99, 132)',   // ì˜ˆ: ë°±ì—”ë“œ
      'rgb(54, 162, 235)',   // ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ
      'rgb(255, 206, 86)',   // ì˜ˆ: ë°ì´í„°
      'rgb(75, 192, 192)',   // ì˜ˆ: ì¸í”„ë¼
      'rgb(153, 102, 255)',  // ì˜ˆ: ê¸°íš
      'rgb(255, 159, 64)'    // ì˜ˆ: ê¸°íƒ€
    ];

    // langLabels: ì§ë¬´ëª… ë°°ì—´, langScores: ê° ì§ë¬´ë³„ íšŒì› ìˆ˜
    // ex) langLabels = ['ë°±ì—”ë“œ', 'í”„ë¡ íŠ¸ì—”ë“œ', ...], langScores = [10, 7, ...]
    const langChipsWrapper = document.getElementById('lang-chips-wrapper');
    const langChipStates = []; // ì¹© í™œì„±/ë¹„í™œì„± ìƒíƒœ ì €ì¥

    // ì¹© ë™ì  ìƒì„± ë° ìƒ‰ìƒ ì¶”ì¶œìš© ë°°ì—´ ì¤€ë¹„
    const chipBgColors = [];
    langLabels.forEach((label, idx) => {
      const chip = document.createElement('div');
      // label ê°’ì„ ì†Œë¬¸ì, ê³µë°±/íŠ¹ìˆ˜ë¬¸ì â†’ í•˜ì´í”ˆ ë“±ìœ¼ë¡œ ë³€í™˜
      // const className = 'chip white-text ' + label.toLowerCase().replace(/ /g, '-');
      const className = 'chip white-text lang-chip ' + label.toLowerCase().replace(/ /g, '-');
      chip.className = className;
      chip.dataset.index = idx;
      chip.textContent = label;
      langChipsWrapper.appendChild(chip);
      langChipStates[idx] = true;
      // ì¹©ì´ DOMì— ì¶”ê°€ëœ í›„ ì‹¤ì œ ë°°ê²½ìƒ‰ ì¶”ì¶œ
      chipBgColors[idx] = window.getComputedStyle(chip).backgroundColor;
    });

    // ì°¨íŠ¸ ìƒì„±
    const langCtx = document.getElementById('langChart');
    let langChart;
    if (langCtx) {
      // yì¶• ìµœëŒ€ê°’ ê³„ì‚°: ë°ì´í„° ìµœëŒ€ê°’ + 1 (ì—¬ìœ  ìˆê²Œ)
      const maxLangScore = Math.max(...langScoresOrigin);
      langChart = new Chart(langCtx, {
        type: 'bar',
        data: {
          labels: langLabels,
          datasets: [{
            label: 'íšŒì› ê´€ì‹¬íƒœê·¸',
            data: langScores,
            // ì¹©ì˜ ì‹¤ì œ ë°°ê²½ìƒ‰ì„ ë§‰ëŒ€ê·¸ë˜í”„ ìƒ‰ìƒìœ¼ë¡œ ì‚¬ìš©
            backgroundColor: chipBgColors,
            borderColor: chipBgColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {display: false},
            tooltip: {enabled: true}
          },
          scales: {
            y: {
              beginAtZero: true,
              // ìµœëŒ€ê°’ì„ ë°ì´í„° ìµœëŒ€ê°’ + 1ë¡œ ì„¤ì •
              max: maxLangScore + 1,
              ticks: {stepSize: 1, precision: 0}
            }
          }
        }
      });

      // ì¹© í´ë¦­ ì´ë²¤íŠ¸ (í† ê¸€)
      langChipsWrapper.querySelectorAll('.chip').forEach((chip, idx) => {
        chip.addEventListener('click', function () {
          langChipStates[idx] = !langChipStates[idx];
          // í•œê¸€ ì£¼ì„: ì¹© í™œì„±/ë¹„í™œì„±ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
          if (!langChipStates[idx]) {
            this.style.backgroundColor = '#bdbdbd';
            langChart.data.datasets[0].data[idx] = 0; // ë¹„í™œì„±í™”: 0ìœ¼ë¡œ
          } else {
            this.style.backgroundColor = langChipColors[idx % langChipColors.length];
            langChart.data.datasets[0].data[idx] = langScoresOrigin[idx]; // í™œì„±í™”: ì›ë³¸ê°’ ë³µêµ¬
          }
          langChart.update();
        });
      });
    }

    // ê´€ì‹¬ ì–¸ì–´ TOP3 ì¶”ì¶œ
    const topLangs = langLabels
    .map((label, idx) => ({label, score: langScores[idx]}))
    .sort((a, b) => b.score - a.score)
    .slice(0, 3)
    .map(item => item.label)
    .join(', ');

    // ì„ì‹œë¡œ ì „ì²´ ìˆ˜ë¡œ ë°”ê¿”ë³´ê¸°
    const todayJoin = /*[[${todayJoin}]]*/ 0;
    const todayLeave = /*[[${todayLeave}]]*/ 0;
    document.getElementById('today-join').textContent = (todayJoin ?? 0);
    document.getElementById('today-leave').textContent = (todayLeave ?? 0);

    // ìš”ì•½ ì¹´ë“œì— ë°ì´í„° ì‚½ì…
    document.getElementById('top-langs').textContent = topLangs;

    fetch('/api/admin/company/stats/data')
    .then(response => response.json())
    .then(data => {
      const ctx = document.getElementById('stacked-bar-chart').getContext('2d');
      const companyLabels = data.labels;
      const companyData = data.data;
      const companyDataOrigin = [...companyData];

      // ìƒ‰ìƒ ë°°ì—´ ìƒì„±
      const companyChipColors = companyLabels.map((_, i) =>
          `hsl(${(i * 40) % 360}, 70%, 70%)`
      );

      // ì°¨íŠ¸ ë¨¼ì € ìƒì„±
      const companyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: companyLabels,
          datasets: [{
            label: 'ì§€ì›ì ìˆ˜',
            data: companyData,
            backgroundColor: companyChipColors,
            borderColor: companyChipColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {display: false}
          },
          scales: {
            y: {
              beginAtZero: true,
              max: Math.max(...companyData) + 1,
              ticks: {stepSize: 1}
            }
          }
        }
      });

      // ì°¨íŠ¸ ìƒì„± ì´í›„ ì¹© ì¶”ê°€
      const chipWrapper = document.getElementById('company-chips-wrapper');
      const chipStates = [];

      companyLabels.forEach((label, idx) => {
        const chip = document.createElement('div');
        // chip.className = 'chip white-text';
        chip.className = 'chip white-text company-chip';
        chip.dataset.index = idx;
        chip.textContent = label;
        chip.style.backgroundColor = companyChipColors[idx];
        chipWrapper.appendChild(chip);
        chipStates[idx] = true;

        // ì¹© í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
        chip.addEventListener('click', function () {
          chipStates[idx] = !chipStates[idx];
          if (!chipStates[idx]) {
            this.style.backgroundColor = '#bdbdbd';
            companyChart.data.datasets[0].data[idx] = 0;
          } else {
            this.style.backgroundColor = companyChipColors[idx];
            companyChart.data.datasets[0].data[idx] = companyDataOrigin[idx];
          }
          companyChart.update();
        });
      });

      // ê¸°ì—… ìš”ì•½ í…ìŠ¤íŠ¸ ì„¤ì •
      const topCompanies = companyLabels.slice(0, 3).join(', ');
      document.getElementById('top-companies').textContent = topCompanies;
    })
    .catch(error => {
      console.error('ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
    });
  });
</script>

</body>
</html>
