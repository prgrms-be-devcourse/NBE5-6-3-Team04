<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>DevQuest Dashboard</title>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/dashboard.css}">
  <link rel="stylesheet" th:href="@{/css/achievement/congratulation.css}">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>
<body>
<div class="top-bar">
  <div class="logo">
    <a href="/admin/dashboard">DevQuest</a>
  </div>
  <div th:replace="~{fragments/header :: header}"></div>
</div>
<div class="dashboard">

  <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
  <aside class="sidebar">
    <div class="createdAt-comment">
      <span class="day-count" th:text="${dashboard.dayCount} + 'ì¼ì§¸'">N ì¼ì§¸</span>
      <span class="comment" th:text="${dashboard.comment}">ìŠ¬ë¡œê±´</span>
    </div>
    <span class="nickname" th:text="${dashboard.nickname}">íšŒì›</span>
    <span class="nickname-sir">ë‹˜</span>

    <!-- ê´€ì‹¬ë¶„ì•¼ íƒœê·¸ -->
    <div class="tags">
      <!-- ì§ë¬´ -->
      <a class="tag" th:each="i : ${dashboard.roles}"
         th:href="${i.roadmapUrl}"
         th:text="'#' + ${i.interestName}"
         target="_blank">#ì§ë¬´</a>
      <a class="tag"
         th:if="${#lists.isEmpty(dashboard.roles)}"
         target="_blank">#ì§ë¬´ ì—†ìŒ</a>

      <!-- ì–¸ì–´ -->
      <a class="tag" th:each="i : ${dashboard.devLangs}"
         th:href="${i.roadmapUrl}"
         th:text="'#' + ${i.interestName}"
         target="_blank">#ì–¸ì–´</a>

      <!-- í”„ë ˆì„ì›Œí¬ -->
      <a class="tag" th:each="i : ${dashboard.frameworks}"
         th:href="${i.roadmapUrl}"
         th:text="'#' + ${i.interestName}"
         target="_blank">#í”„ë ˆì„ì›Œí¬</a>
    </div>

    <!--  ë§ˆì´í˜ì´ì§€  -->
    <p class="mypage">
      <a th:href="@{/user/mypage}">
        <span class="material-icons">account_circle</span>ë§ˆì´í˜ì´ì§€
      </a>
    </p>

    <!-- í”„ë¡œí•„ ì¹´ë“œ -->
    <div class="profile-card">
      <div class="profile-card">
        <div class="profile-info">
          <img class="profile-img"
               th:src="${dashboard.userImage != null && !dashboard.userImage.isEmpty()
             ? '/images/profile/' + dashboard.userImage
             : '/images/profile/default.png'}"
               alt="í”„ë¡œí•„ ì´ë¯¸ì§€"/>

          <div class="level-info">
            <p class="level-title" th:text="${user.level.levelName}">ë ˆë²¨ëª…</p>
            <p class="level" th:text="'Lv. ' + ${user.level.levelId}">Lv. N</p>
          </div>

        </div>

        <!--  xp ì§„í–‰ë°”  -->
        <div class="xp-label" th:text="${dashboard.exp} + 'xp'">N xp</div>
        <div class="xp-bar">
          <div class="xp-progress" th:style="'width:' + ${dashboard.progressPercent} + '%'"></div>
          <span>[[${dashboard.progressPercent}]]%</span>
        </div>
      </div>
    </div>

    <!--  ì•Œë¦¼ í† ê¸€  -->
    <div class="toggle-box">
      <form th:action="@{/dashboard/notification-toggle}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="checkbox"
               name="notification"
               th:checked="${dashboard.notificationOn}" onchange="this.form.submit()">
        <label>ì•Œë¦¼</label>
      </form>
    </div>

    <!--  ì£¼ìš”ì•Œë¦¼  -->
    <div class="alert-box">
      <h3>
        ğŸ”” ì£¼ìš” ì•Œë¦¼
        <span class="count" th:text="${#lists.size(dashboard.alerts)}">0</span>
      </h3>
      <ul th:if="${dashboard.notificationOn}">
        <li th:each="alert : ${dashboard.alerts}">
          <span class="material-icons">access_alarms</span>
          <strong th:text="${alert.companyName} + ' - '">ê¸°ì—…ëª…</strong>
          <span th:text="${alert.status != null ? alert.status.label : 'ìƒíƒœ ì—†ìŒ'}">ìƒíƒœ</span>
          <span style="color: #6331b1; font-weight: bold" th:text="'D - ' + ${alert.dDay}"></span><span th:text="${alert.dDay == 0} ? 'ì…ë‹ˆë‹¤. ğŸ£' : 'ì…ë‹ˆë‹¤.'"></span>
        </li>
      </ul>
      <p th:unless="${dashboard.notificationOn}">
        í˜„ì¬ ì•Œë¦¼ì´ êº¼ì ¸ ìˆì–´ìš” ğŸ”•
      </p>
    </div>
  </aside>

  <main class="main-content">

    <!--  Company List   -->
    <p class="section-title">ëª©í‘œ ê¸°ì—… ëª©ë¡</p>

    <div class="company-list">

      <div th:each="company : ${dashboard.goalCompanies}"
           class="company-card"
           th:classappend="|
             ${company.companyName.toLowerCase()}
             ${(company.companyName == 'ë„¤ì´ë²„') ? ' naver' : ''}
             ${(company.companyName == 'í† ìŠ¤') ? ' toss' : ''}
             ${(company.companyName == 'ë‹¹ê·¼') ? ' danggeun' : ''}
             ${(company.companyName == 'ë°°ë‹¬ì˜ë¯¼ì¡±') ? ' baemin' : ''}
             ${(company.companyName == 'ì¹´ì¹´ì˜¤') ? ' kakao' : ''}
           |">

        <div class="card-header">
          <span class="status" th:text="${company.statusLabel}">ì§„í–‰ ìƒíƒœ</span>
          <span class="dDay" th:text="'D-' + ${company.DDay}">D-day</span>

          <!-- ìˆ˜ì •/ì‚­ì œ ë“œë¡­ë‹¤ìš´  -->
          <div class="dropdown" onclick="event.stopPropagation()">
            <button class="dropdown-toggle" type="button"> â‹®  </button>
            <ul class="dropdown-menu">
              <li class="update-btn" th:attr="data-id=${company.companyId}">ìˆ˜ì •</li>
              <li class="delete-btn" th:attr="data-id=${company.companyId}">ì‚­ì œ</li>
            </ul>
          </div>
        </div>

        <a th:href="@{/companies/{companyId}/select(companyId=${company.companyId})}"
           style="text-decoration: none; color: inherit; ">

          <!-- ëª©í‘œ ê¸°ì—… ì¹´ë“œ ë‚´ìš© -->
          <p class="company-name" th:text="${company.companyName}">íšŒì‚¬ëª…</p>
          <p class="content" th:text="${company.content}">ë‚´ìš©</p>
          <div class="status-dDay">
            <span class="status" th:text="${company.statusLabel}">ì§„í–‰ ìƒíƒœ</span>
            <span class="endDate" th:text="'~' + ${company.endDate}">~ë§ˆê°ì¼</span>
          </div>
        </a>
      </div>

      <!-- TODO ìƒì„± ì¹´ë“œ -->
      <div class="company-card create" onclick="openModal('companyModal')">
        <p class="goal-todo-desc-top">
          <span class="material-icons">control_point</span>
          ëª©í‘œ ê¸°ì—… TODO ìƒì„±
        </p>
        <p class="goal-todo-desc-bottom">
          ëª©í‘œ ê¸°ì—…ì„ ìƒì„±í•˜ì‹œë ¤ë©´ ì´ê³³ì„ í´ë¦­í•´ì£¼ì„¸ìš”
        </p>
      </div>
    </div>
  </main>


  <!-- ëª©í‘œ ê¸°ì—… ìƒì„± ëª¨ë‹¬ -->
  <div id="companyModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal('companyModal')">&times;</span>
      <h2>ëª©í‘œ ê¸°ì—… ìƒì„±</h2>
      <form id="create-form">
        <input type="text" name="companyName" placeholder="ê¸°ì—…ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required><br><br>
        <input type="text" name="content" placeholder="ì–´ë–¤ ê°œë°œìê°€ ë˜ê³  ì‹¶ì€ì§€ í•œë§ˆë””" required><br><br>
        <label>ì¼ì •</label><br>
        <select name="status">
          <option value="DOCUMENT">ì„œë¥˜ ë§ˆê°</option>
          <option value="CODING_TEST">ì½”ë”©í…ŒìŠ¤íŠ¸</option>
          <option value="ASSIGNMENT">ê³¼ì œ</option>
          <option value="APTITUDE">ì¸ì ì„±ê²€ì‚¬</option>
          <option value="INTERVIEW_1">1ì°¨ ë©´ì ‘</option>
          <option value="INTERVIEW_2">2ì°¨ ë©´ì ‘</option>
          <option value="INTERVIEW_3">3ì°¨ ë©´ì ‘ (ì»¬ì²˜í•)</option>
        </select><br><br>
        <label>ë§ˆê°ì¼</label><br>
        <input type="date" name="endDate" required><br><br>
        <button type="submit">ìƒì„±</button>
      </form>
    </div>
  </div>
  <div th:replace="~{fragments/achievement-modal :: achievementModal}"></div>

  <script src="/js/header.js" defer></script>

  <script>
    // ë“œë¡­ë‹¤ìš´(ìˆ˜ì •, ì‚­ì œ)
    document.addEventListener('DOMContentLoaded', () => {
      const toggles = document.querySelectorAll('.dropdown-toggle');

      toggles.forEach((toggle) => {
        toggle.addEventListener('click', (e) => {
          e.stopPropagation(); // ë‹¤ë¥¸ ê³³ í´ë¦­ ë§‰ê¸°
          // ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
          document.querySelectorAll('.dropdown-menu').forEach(menu => {
            if (menu !== toggle.nextElementSibling) {
              menu.style.display = 'none';
            }
          });
          // í˜„ì¬ ê²ƒë§Œ í† ê¸€
          const menu = toggle.nextElementSibling;
          menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';

          const items = menu.querySelectorAll('li');
          items.forEach(item => {
            item.addEventListener('click', (e) => {
              e.stopPropagation(); // ìˆ˜ì •, ì‚­ì œ ëˆŒëŸ¬ë„ ìƒì„¸ ì§„ì… ì•ˆ ë¨
            });
          });
        });
      });

      document.querySelectorAll('.dropdown-toggle, .dropdown-menu').forEach(el => {
        el.addEventListener('click', e => {
          e.stopPropagation();
        });
      });

      // í˜ì´ì§€ ì–´ë””ë“  í´ë¦­í•˜ë©´ ë©”ë‰´ ë‹«í˜
      document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
          menu.style.display = 'none';
        });
      });
    });
  </script>


  <script>
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    function getCsrfHeaders() {
      return {
        [csrfHeader]: csrfToken
      };
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("create-form");

      // ìƒì„± ì¹´ë“œ ëˆŒë €ì„ ë•Œ
      document.querySelector(".company-card.create").addEventListener("click", () => {
        form.reset();
        form.removeAttribute("data-id");
        document.querySelector("#companyModal h2").textContent = "ëª©í‘œ ê¸°ì—… ìƒì„±";
        document.querySelector("#companyModal button[type='submit']").textContent = "ìƒì„±";
        form.onsubmit = function (e) {
          e.preventDefault();
          createCompany();
        };
        openModal("companyModal");
      });

      // ìˆ˜ì • ë²„íŠ¼ë“¤
      document.querySelectorAll(".update-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const companyId = btn.dataset.id;
          fillForm(companyId);
          form.setAttribute("data-id", companyId);
          document.querySelector("#companyModal h2").textContent = "ëª©í‘œ ê¸°ì—… ìˆ˜ì •";
          document.querySelector("#companyModal button[type='submit']").textContent = "ìˆ˜ì •";
          form.onsubmit = function (e) {
            e.preventDefault();
            updateCompany(e);
          };
          openModal("companyModal");
        });
      });

      // ì‚­ì œ ë²„íŠ¼ë“¤
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const companyId = btn.dataset.id;
          deleteCompany(companyId);
        });
      });
    });

    // ëª©í‘œ ê¸°ì—… ìƒì„± í•¨ìˆ˜
    function createCompany() {
      const form = document.getElementById("create-form"); // ì „ì—­ì—ì„œ í•œë²ˆë§Œ ë°›ì•„ë„ ë¬´ë°©í•¨
      const data = {
        companyName: form.companyName.value,
        content: form.content.value,
        status: form.status.value,
        endDate: form.endDate.value
      };

      fetch('/companies/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...getCsrfHeaders()
        },
        body: JSON.stringify(data)
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${res.status}`);
        }
        return res.json();
      })
      .then(result => {
        closeModal("companyModal");

        const baseUrl = `${window.location.origin}${window.location.pathname}`;

        if (result.achievementName) {
          const encodedName = encodeURIComponent(result.achievementName);
          const redirectUrl = `${baseUrl}?achievementName=${encodedName}`;
          window.location.href = redirectUrl;
        } else {
          alert("ë“±ë¡ ì™„ë£Œ!");
          window.location.reload();
        }
      })
      .catch(error => {
        console.error("ğŸš¨ ì—ëŸ¬ ë°œìƒ:", error);
        alert("ì—ëŸ¬ ë°œìƒ");
      });
    }

    // ëª©í‘œ ê¸°ì—… ì‚­ì œ í•¨ìˆ˜
    function deleteCompany(companyId) {
      console.log("ì‚­ì œ ìš”ì²­ ID:", companyId);
      if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        fetch(`/companies/${companyId}/delete`, {
          method: 'DELETE',
          headers: {
            ...getCsrfHeaders()
          }
        })
        .then(res => {
          if (res.ok) {
            alert("ì‚­ì œ ì™„ë£Œ!");
            window.location.reload(); // ìƒˆë¡œê³ ì¹¨
          } else {
            alert("ì‚­ì œ ì‹¤íŒ¨");
          }
        })
        .catch(err => {
          console.error(err);
          alert("ì—ëŸ¬ ë°œìƒ");
        });
      }
    }

    function fillForm(companyId) {
      fetch(`/companies/${companyId}`)
      .then(res => res.json())
      .then(data => {
        const form = document.getElementById("create-form");
        form.companyName.value = data.companyName;
        form.content.value = data.content;
        form.status.value = data.status;
        form.endDate.value = data.endDate;
      })
      .catch(err => {
        console.error("íšŒì‚¬ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", err);
        alert("ìˆ˜ì •í•  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      });
    }

    //ëª©í‘œ ê¸°ì—… ìˆ˜ì • í•¨ìˆ˜
    function updateCompany(e) {
      e.preventDefault();

      const form = document.getElementById("create-form");
      const companyId = form.dataset.id;

      const data = {
        companyName: form.companyName.value,
        content: form.content.value,
        status: form.status.value,
        endDate: form.endDate.value
      };

      fetch(`/companies/${companyId}/update`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          ...getCsrfHeaders()
        },
        body: JSON.stringify(data)
      })
      .then(res => {
        if (!res.ok) {
          throw new Error('ìˆ˜ì • ì‹¤íŒ¨');
        }
        return res.text();
      })
      .then(msg => {
        alert("ìˆ˜ì • ì™„ë£Œ!");
        closeModal("companyModal");
        location.reload();
      })
      .catch(err => {
        console.error(err);
        alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      });
    }

    function openModal(companyModal) {
      document.getElementById(companyModal).style.display = "flex";
    }

    function closeModal(companyModal) {
      document.getElementById(companyModal).style.display = "none";
    }
  </script>
</body>
<script defer src="/js/achievement/congratulation.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</html>